<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>KAU IFC Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --kau-green:#0b6b3a;
  --panel:#f2f3f5;
  --border:#d7d9de;
  --btn:#e9eaee;
  --text:#111;
  --muted:#666;
}
*{ box-sizing:border-box; font-family:system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
body{ margin:0; background:#fff; color:var(--text); }

.topbar{
  background:var(--kau-green);
  color:#fff;
  padding:10px 14px;
  text-align:center;
  font-weight:600;
}

.toolbar{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px 12px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}

input[type=file]{
  width:240px;
  padding:6px;
  border:1px solid var(--border);
  border-radius:8px;
  background:#fff;
}

button{
  padding:8px 10px;
  border:1px solid var(--border);
  background:var(--btn);
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
}

#status{
  margin-left:auto;
  font-size:13px;
  color:var(--muted);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:45vw;
}

.main{
  height: calc(100vh - 48px - 52px);
  display:grid;
  grid-template-columns: 280px 1fr 320px;
  gap:10px;
  padding:10px;
}

.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:14px;
  padding:10px;
  overflow:auto;
}

#viewerWrap{
  background:#fff;
  border:1px solid var(--border);
  border-radius:14px;
  overflow:hidden;
  position:relative;
  min-height:320px;
}

#c{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  display:block;
}
</style>
</head>

<body>
  <div class="topbar">Architecture and Design College — King Abdulaziz University</div>

  <div class="toolbar">
    <input id="fileInput" type="file" accept=".ifc">
    <button id="resetBtn" type="button">Reset View</button>
    <button id="clearBtn" type="button">Clear Model</button>
    <div id="status">Ready</div>
  </div>

  <div class="main">
    <div class="panel">
      <b>Floors</b>
      <div style="margin-top:10px; font-size:12px; color:var(--muted); line-height:1.4;">
        Floor filtering comes next. For now, the goal is: grid shows + IFC loads + click shows info.
      </div>
    </div>

    <div id="viewerWrap">
      <canvas id="c"></canvas>
    </div>

    <div class="panel">
      <b>Element Info</b>
      <div id="info" style="margin-top:10px; font-size:13px; line-height:1.5;">
        Click any element after loading an IFC.
      </div>
    </div>
  </div>

<script type="module">
  import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.155.0/build/three.module.js";
  import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.155.0/examples/jsm/controls/OrbitControls.js";
  import { IFCLoader } from "https://cdn.jsdelivr.net/npm/web-ifc-three@0.0.126/IFCLoader.js";

  var WASM_PATH = "https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/";

  var canvas = document.getElementById("c");
  var statusEl = document.getElementById("status");
  var infoEl = document.getElementById("info");
  var fileInput = document.getElementById("fileInput");
  var resetBtn = document.getElementById("resetBtn");
  var clearBtn = document.getElementById("clearBtn");

  var scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffffff);

  var camera = new THREE.PerspectiveCamera(60, 1, 0.1, 5000);
  camera.position.set(15, 12, 15);

  var renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
  renderer.setPixelRatio(window.devicePixelRatio || 1);

  var controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  // Lights
  scene.add(new THREE.AmbientLight(0xffffff, 0.85));
  var dir = new THREE.DirectionalLight(0xffffff, 0.6);
  dir.position.set(10, 20, 10);
  scene.add(dir);

  // ✅ GRID + AXES (should appear immediately)
  scene.add(new THREE.GridHelper(100, 100));
  scene.add(new THREE.AxesHelper(5));

  // IFC
  var ifcLoader = new IFCLoader();
  ifcLoader.ifcManager.setWasmPath(WASM_PATH);

  var ifcModel = null;

  function resize() {
    var parent = canvas.parentElement;
    var w = parent.clientWidth;
    var h = parent.clientHeight;
    if (w < 300) w = 300;
    if (h < 300) h = 300;
    renderer.setSize(w, h, false);
    camera.aspect = w / h;
    camera.updateProjectionMatrix();
  }

  var ro = new ResizeObserver(function() { resize(); });
  ro.observe(canvas.parentElement);
  resize();

  function animate() {
    controls.update();
    renderer.render(scene, camera);
    requestAnimationFrame(animate);
  }
  animate();

  function safeVal(v) {
    if (v === null || v === undefined) return "-";
    return String(v);
  }

  function getPropValue(props, key) {
    if (!props) return "-";
    if (!props[key]) return "-";
    // IFC props often like { value: "..." }
    if (props[key].value !== undefined && props[key].value !== null) return String(props[key].value);
    return String(props[key]);
  }

  function setInfoHtml(name, type, gid) {
    infoEl.innerHTML =
      "<div><b>Name:</b> " + safeVal(name) + "</div>" +
      "<div><b>Type:</b> " + safeVal(type) + "</div>" +
      "<div><b>GlobalId:</b> " + safeVal(gid) + "</div>";
  }

  function clearInfo() {
    infoEl.textContent = "Click any element after loading an IFC.";
  }

  fileInput.addEventListener("change", function(e) {
    var file = e.target.files && e.target.files[0];
    if (!file) return;

    statusEl.textContent = "Loading IFC…";

    // Remove old model
    if (ifcModel) {
      scene.remove(ifcModel);
      ifcModel = null;
    }
    clearInfo();

    var url = URL.createObjectURL(file);

    ifcLoader.loadAsync(url).then(function(model) {
      ifcModel = model;
      scene.add(ifcModel);
      controls.reset();
      statusEl.textContent = "Loaded ✔ Click elements.";
    }).catch(function(err) {
      console.error(err);
      statusEl.textContent = "Load failed ❌";
      infoEl.textContent = "IFC load failed. Check console for details.";
    });
  });

  resetBtn.addEventListener("click", function() {
    controls.reset();
    statusEl.textContent = "View reset.";
  });

  clearBtn.addEventListener("click", function() {
    if (ifcModel) {
      scene.remove(ifcModel);
      ifcModel = null;
    }
    clearInfo();
    statusEl.textContent = "Model cleared.";
    // keep file selection as-is (don’t reset file input)
  });

  canvas.addEventListener("click", function(e) {
    if (!ifcModel) return;

    var rect = canvas.getBoundingClientRect();
    var x = ((e.clientX - rect.left) / rect.width) * 2 - 1;
    var y = -(((e.clientY - rect.top) / rect.height) * 2 - 1);

    var mouse = new THREE.Vector2(x, y);
    var ray = new THREE.Raycaster();
    ray.setFromCamera(mouse, camera);

    var hits = ray.intersectObject(ifcModel, true);
    if (!hits || hits.length === 0) return;

    var hit = hits[0];
    if (hit.faceIndex === undefined || hit.faceIndex === null) return;

    var expressId = ifcLoader.ifcManager.getExpressId(hit.object.geometry, hit.faceIndex);

    ifcLoader.ifcManager.getItemProperties(ifcModel.modelID, expressId, true).then(function(props) {
      var name = getPropValue(props, "Name");
      var gid = getPropValue(props, "GlobalId");
      var type = props && props.type ? String(props.type) : "-";
      setInfoHtml(name, type, gid);
    }).catch(function(err) {
      console.error(err);
      infoEl.textContent = "Failed to read properties (see console).";
    });
  });

  statusEl.textContent = "Viewer ready (grid should be visible).";
</script>
</body>
</html>
