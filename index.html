<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAU IFC Viewer</title>

  <style>
    :root{
      --kau-green:#0b6b3a;
      --bg:#ffffff;
      --panel:#f2f3f5;
      --panel2:#e6e7ea;
      --text:#111;
      --muted:#666;
      --border:#d7d9de;
      --btn:#e9eaee;
      --btn-hover:#dfe1e7;
      --btn-active:#0b6b3a;
      --btn-active-text:#fff;
      --danger:#b91c1c;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    .topbar{
      background:var(--kau-green);
      color:#fff;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      letter-spacing:.2px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }

    .toolbar .label{
      font-size:14px;
      color:var(--text);
      font-weight:600;
      white-space: nowrap;
    }

    input[type="file"]{
      width:240px;
      max-width:240px;
      padding:6px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:13px;
    }

    .btn{
      padding:8px 10px;
      border:1px solid var(--border);
      background:var(--btn);
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space: nowrap;
      font-size:13px;
      transition: all 0.2s;
    }
    .btn:hover{ background:var(--btn-hover); }
    .btn.active{
      background:var(--btn-active);
      color:var(--btn-active-text);
      border-color:var(--btn-active);
    }

    .status{
      margin-left:auto;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:45vw;
    }

    .main{
      height: calc(100vh - 48px - 52px);
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:10px;
      padding:10px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      overflow:auto;
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size:14px;
    }

    #viewerWrap{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }
    #viewer{
      position:absolute;
      inset:0;
    }

    .smallRow{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; margin-bottom:10px; }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      font-size:13px;
      width: 100%;
    }

    .floorList .btn{
      width:100%;
      text-align:left;
      margin:6px 0;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:8px;
    }

    .kv{ font-size:13px; line-height:1.5; }
    .kv b{ display:inline-block; min-width:120px; }
    .divider{ height:1px; background:var(--border); margin:10px 0; }

    #errorBox{
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--danger);
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }

    /* Loading overlay */
    #overlay{
      position:absolute;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(4px);
      z-index:10;
    }
    #overlay .card{
      width:min(520px, 92vw);
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }
    #overlay .title{ font-weight:800; margin-bottom:8px; }
    #overlay .msg{ color:var(--muted); font-size:13px; line-height:1.35; }

    .success-msg{
      padding:10px;
      background:#dcfce7;
      border:1px solid #86efac;
      border-radius:12px;
      color:#166534;
      font-size:12px;
      margin-top:10px;
      display:none;
    }

    @media (max-width: 900px) {
      .main{
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr auto;
      }
    }
  </style>
</head>

<body>
  <div class="topbar">Architecture and Design College ‚Äî King Abdulaziz University</div>

  <div class="toolbar">
    <div class="label">Load IFC</div>
    <input id="fileInput" type="file" accept=".ifc" />
    <button id="resetBtn" class="btn" type="button">Reset Camera</button>
    <button id="clearBtn" class="btn" type="button">Clear Model</button>
    <div id="status" class="status">Ready.</div>
  </div>

  <div class="main">
    <!-- Left -->
    <div class="panel">
      <h3>Controls</h3>

      <div class="smallRow">
        <div class="toggle">
          <input id="roomsOnly" type="checkbox" />
          <label for="roomsOnly">Rooms only</label>
        </div>
      </div>

      <div class="divider"></div>

      <h3>Floors</h3>
      <div id="floorList" class="floorList">
        <p class="hint">Load an IFC file to see available floors.</p>
      </div>

      <div id="successBox" class="success-msg"></div>
      <div id="errorBox"></div>

      <div class="hint">
        üí° Click floor buttons to isolate levels. Click elements in 3D view to see properties.
      </div>
    </div>

    <!-- Middle viewer -->
    <div id="viewerWrap">
      <div id="overlay">
        <div class="card">
          <div class="title">Loading IFC‚Ä¶</div>
          <div id="overlayMsg" class="msg">Parsing + generating geometry‚Ä¶</div>
        </div>
      </div>
      <div id="viewer"></div>
    </div>

    <!-- Right -->
    <div class="panel">
      <h3>Selected Element Info</h3>
      <div id="info" class="kv">Click any element in the model.</div>
      <div class="divider"></div>
      <div class="hint">
        ‚ÑπÔ∏è Element properties appear here when you click objects in the 3D viewer.
      </div>
    </div>
  </div>

  <script type="module">
    import * as THREE from "https://esm.sh/three@0.155.0";
    import { IfcViewerAPI } from "https://esm.sh/web-ifc-viewer@1.0.218";

    const statusEl = document.getElementById("status");
    const infoEl = document.getElementById("info");
    const fileInput = document.getElementById("fileInput");
    const resetBtn = document.getElementById("resetBtn");
    const clearBtn = document.getElementById("clearBtn");
    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");
    const floorListEl = document.getElementById("floorList");
    const viewerWrap = document.getElementById("viewerWrap");
    const overlay = document.getElementById("overlay");
    const overlayMsg = document.getElementById("overlayMsg");
    const roomsOnlyCheckbox = document.getElementById("roomsOnly");

    let viewer = null;
    let currentModelID = null;
    let allStoreys = [];
    let allRooms = [];
    let roomColors = {};
    let activeFloorButton = null;

    // Random color palette for rooms
    const colorPalette = [
      0x95db55, 0x3a7feb, 0x554abc, 0x4e40cf, 0xb8e236,
      0x7ec748, 0x7acd31, 0xec7748, 0x601cc3, 0x3bb523,
      0xff6b6b, 0x4ecdc4, 0x45b7d1, 0xfeca57, 0xee5a6f,
      0xc44569, 0xf8b500, 0x1abc9c, 0x3498db, 0x9b59b6,
      0xe74c3c, 0x2ecc71, 0xf39c12, 0xd35400, 0xc0392b,
      0x16a085, 0x27ae60, 0x2980b9, 0x8e44ad, 0x2c3e50,
      0xe67e22, 0x1abc9c, 0x34495e, 0x95a5a6, 0x7f8c8d,
      0xecf0f1, 0xbdc3c7, 0xffd93d, 0x6bcf7f, 0xff6348,
      0x5f27cd, 0x48dbfb, 0xff9ff3, 0x54a0ff, 0x00d2d3,
      0x1dd1a1, 0xfeca57, 0xff6b6b, 0xee5a6f, 0xc44569
    ];

    function setStatus(msg){ statusEl.textContent = msg; }

    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      successBox.style.display = "none";
    }

    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    function showSuccess(msg){
      successBox.style.display = "block";
      successBox.textContent = msg;
      errorBox.style.display = "none";
    }

    function setOverlay(on, msg){
      overlay.style.display = on ? "flex" : "none";
      if (msg) overlayMsg.textContent = msg;
    }

    function escapeHtml(v){
      return String(v).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function clearInfo(){
      infoEl.innerHTML = "Click any element in the model.";
    }

    function initViewer(){
      const container = document.getElementById("viewer");

      viewer = new IfcViewerAPI({
        container,
        backgroundColor: new THREE.Color(0xffffff)
      });

      viewer.IFC.setWasmPath("https://unpkg.com/web-ifc@0.0.66/");

      viewer.axes.setAxes();
      viewer.grid.setGrid();

      setStatus("Viewer initialized. Choose an IFC file.");
    }

    function clearModel(){
      if (!viewer) return;

      if (currentModelID !== null){
        try { viewer.IFC.loader.ifcManager.close(currentModelID); } catch (e) {}
        currentModelID = null;
      }
      allStoreys = [];
      allRooms = [];
      roomColors = {};
      activeFloorButton = null;
      floorListEl.innerHTML = '<p class="hint">Load an IFC file to see available floors.</p>';
      clearInfo();
      clearError();
      successBox.style.display = "none";
      setStatus("Model cleared.");
    }

    async function loadIfcRobust(file){
      if (!viewer) initViewer();

      clearError();
      clearInfo();
      setOverlay(true, "Reading file‚Ä¶");
      setStatus("Loading IFC‚Ä¶");

      clearModel();

      const url = URL.createObjectURL(file);

      try{
        setOverlay(true, "Parsing IFC‚Ä¶");
        const model = await viewer.IFC.loadIfcUrl(url);

        if (model && typeof model.modelID === "number") {
          currentModelID = model.modelID;

          setOverlay(true, "Extracting building data‚Ä¶");
          await extractBuildingStructure();

          setOverlay(true, "Finishing‚Ä¶");
          try { viewer.context.fitToFrame(); } catch(e) {}

          setOverlay(false);
          showSuccess(`‚úì Model loaded with ${allStoreys.length} floors and ${allRooms.length} rooms`);
          setStatus("Model loaded ‚úÖ");
          return;
        }
      } catch (e) {
        setOverlay(false);
        throw e;
      }

      setOverlay(false);
      throw new Error("IFC load failed. File may be invalid.");
    }

    async function extractBuildingStructure(){
      if (!viewer || currentModelID === null) return;

      try {
        // Get all building storeys
        const IFCBUILDINGSTOREY = 3124254112;
        const storeyIDs = await viewer.IFC.loader.ifcManager.getAllItemsOfType(currentModelID, IFCBUILDINGSTOREY, false);

        allStoreys = [];
        for (let id of storeyIDs) {
          const props = await viewer.IFC.getProperties(currentModelID, id, false, false);
          allStoreys.push({
            expressID: id,
            name: props.Name?.value || `Storey ${id}`,
            longName: props.LongName?.value || ""
          });
        }

        // Get all rooms/spaces
        const IFCSPACE = 3856911033;
        const spaceIDs = await viewer.IFC.loader.ifcManager.getAllItemsOfType(currentModelID, IFCSPACE, false);

        allRooms = spaceIDs || [];

        // Assign random colors to rooms
        allRooms.forEach((roomID, index) => {
          roomColors[roomID] = colorPalette[index % colorPalette.length];
        });

        buildFloorButtons();
      } catch (e) {
        console.error("Error extracting structure:", e);
        allStoreys = [];
        allRooms = [];
      }
    }

    function buildFloorButtons(){
      if (allStoreys.length === 0) {
        floorListEl.innerHTML = '<p class="hint">No floors detected in this IFC.</p>';
        return;
      }

      let html = "";
      allStoreys.forEach((storey, idx) => {
        html += `<button class="btn floor-btn" data-floor-id="${storey.expressID}">${escapeHtml(storey.name)}</button>`;
      });
      html += `<button class="btn floor-btn active" data-floor-id="all">Whole Building</button>`;

      floorListEl.innerHTML = html;

      document.querySelectorAll(".floor-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          handleFloorClick(btn);
        });
      });
    }

    function handleFloorClick(btn){
      // Remove active class from previous button
      if (activeFloorButton) {
        activeFloorButton.classList.remove("active");
      }

      // Add active class to clicked button
      btn.classList.add("active");
      activeFloorButton = btn;

      const floorId = btn.dataset.floorId;

      if (floorId === "all") {
        showAllElements();
        setStatus("Showing whole building");
      } else {
        isolateFloor(parseInt(floorId));
        setStatus(`Floor isolated: ${btn.textContent}`);
      }
    }

    function showAllElements(){
      if (!viewer || !viewer.IFC || !viewer.IFC.selector || !viewer.IFC.selector.unpickIfcItems) return;
      try {
        viewer.IFC.selector.unpickIfcItems();
      } catch (e) {
        console.error("Error showing all elements:", e);
      }
    }

    async function isolateFloor(storeyExpressID){
      // This is a placeholder for floor isolation
      // Full implementation would require hiding/showing specific elements
      setStatus(`Floor isolation: ${storeyExpressID} (full implementation pending)`);
      console.log("Isolating floor:", storeyExpressID);
    }

    async function applyRoomColors(){
      if (!viewer || currentModelID === null || allRooms.length === 0) return;

      try {
        for (let roomID of allRooms) {
          const color = roomColors[roomID];
          if (color) {
            // Apply color to room
            const subset = viewer.IFC.loader.ifcManager.createSubset({
              modelID: currentModelID,
              ids: [roomID],
              removePrevious: false,
              customID: `room-${roomID}`,
              material: new THREE.MeshLambertMaterial({
                color: color,
                transparent: true,
                opacity: 0.6
              })
            });
          }
        }
        showSuccess(`‚úì Applied colors to ${allRooms.length} rooms`);
      } catch (e) {
        console.error("Error applying room colors:", e);
      }
    }

    async function pickAndShowInfo(){
      if (!viewer || currentModelID === null) return;

      const result = await viewer.IFC.selector.pickIfcItem(false);
      if (!result) return;

      const props = await viewer.IFC.getProperties(result.modelID, result.id, true, false);

      const name = props?.Name?.value || "-";
      const globalId = props?.GlobalId?.value || "-";
      const type = props?.type || "-";
      const objectType = props?.ObjectType?.value || "-";

      let html = `
        <div><b>Name:</b> ${escapeHtml(name)}</div>
        <div><b>Type:</b> ${escapeHtml(type)}</div>
        <div><b>Object Type:</b> ${escapeHtml(objectType)}</div>
        <div><b>GlobalId:</b> ${escapeHtml(globalId)}</div>
      `;

      // Add additional properties if available
      if (props.psets && props.psets.length > 0) {
        html += '<div class="divider"></div><b>Properties:</b>';
        props.psets.slice(0, 3).forEach(pset => {
          if (pset.HasProperties) {
            pset.HasProperties.slice(0, 5).forEach(prop => {
              const pName = prop.Name?.value || "";
              const pValue = prop.NominalValue?.value || "";
              if (pName && pValue) {
                html += `<div style="font-size:12px; margin-left:10px;">${escapeHtml(pName)}: ${escapeHtml(String(pValue))}</div>`;
              }
            });
          }
        });
      }

      infoEl.innerHTML = html;
    }

    // Init viewer
    try{
      initViewer();
    }catch(err){
      console.error(err);
      showError("Viewer init failed:\n" + (err?.stack || err?.message || String(err)));
      setStatus("Init failed ‚ùå");
    }

    // File select
    fileInput.addEventListener("change", async (e) => {
      const file = e.target.files?.[0];
      if (!file) return;

      try{
        await loadIfcRobust(file);
      }catch(err){
        console.error(err);
        showError(
          "IFC load failed.\n\n" +
          "Suggestions:\n" +
          "1) Export as IFC4 Reference View from Revit\n" +
          "2) Check file is valid IFC\n" +
          "3) Try smaller test file\n\n" +
          "Error: " + (err?.message || String(err))
        );
        setStatus("Failed to load IFC ‚ùå");
      }
    });

    resetBtn.addEventListener("click", () => {
      if (!viewer) return;
      try { viewer.context.fitToFrame(); } catch (e) {}
      setStatus("Camera reset.");
    });

    clearBtn.addEventListener("click", () => {
      clearError();
      setOverlay(false);
      clearModel();
    });

    viewerWrap.addEventListener("click", async () => {
      try { await pickAndShowInfo(); } catch (e) { console.error(e); }
    });

    // Rooms only toggle
    roomsOnlyCheckbox.addEventListener("change", async (e) => {
      if (e.target.checked) {
        await applyRoomColors();
        setStatus("Rooms colored ‚úì");
      } else {
        showAllElements();
        setStatus("Room colors cleared");
      }
    });

  </script>
</body>
</html>
