<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAU IFC Viewer</title>

  <style>
    :root{
      --kau-green:#0b6b3a;
      --bg:#ffffff;
      --panel:#f2f3f5;
      --panel2:#e6e7ea;
      --text:#111;
      --muted:#666;
      --border:#d7d9de;
      --btn:#e9eaee;
      --btn-hover:#dfe1e7;
      --btn-active:#0b6b3a;
      --btn-active-text:#fff;
      --danger:#b91c1c;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    .topbar{
      background:var(--kau-green);
      color:#fff;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      letter-spacing:.2px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
      flex-wrap:wrap;
    }

    .toolbar .label{
      font-size:14px;
      color:var(--text);
      font-weight:600;
      white-space: nowrap;
    }

    input[type="file"]{
      width:240px;
      max-width:240px;
      padding:6px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
      font-size:13px;
    }

    .btn{
      padding:8px 10px;
      border:1px solid var(--border);
      background:var(--btn);
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space: nowrap;
      font-size:13px;
      transition: all 0.2s;
    }
    .btn:hover{ background:var(--btn-hover); }

    .status{
      margin-left:auto;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
    }

    .main{
      height: calc(100vh - 48px - 52px);
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:10px;
      padding:10px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      overflow:auto;
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size:14px;
      font-weight:600;
    }

    #viewerWrap{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }
    
    #viewer{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
    }

    .divider{ height:1px; background:var(--border); margin:10px 0; }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:8px;
    }

    .kv{ font-size:13px; line-height:1.5; }
    .kv b{ display:inline-block; min-width:100px; }

    .success-msg{
      padding:10px;
      background:#dcfce7;
      border:1px solid #86efac;
      border-radius:8px;
      color:#166534;
      font-size:12px;
      margin-top:10px;
      display:none;
    }

    .error-msg{
      padding:10px;
      background:#fee2e2;
      border:1px solid #fca5a5;
      border-radius:8px;
      color:#b91c1c;
      font-size:12px;
      margin-top:10px;
      display:none;
      white-space:pre-wrap;
    }

    .floorList .btn{
      width:100%;
      text-align:left;
      margin:6px 0;
    }
  </style>
</head>

<body>
  <div class="topbar">Architecture and Design College â€” King Abdulaziz University</div>

  <div class="toolbar">
    <div class="label">Load IFC</div>
    <input id="fileInput" type="file" accept=".ifc" />
    <button id="resetBtn" class="btn" type="button">Reset Camera</button>
    <button id="clearBtn" class="btn" type="button">Clear Model</button>
    <div id="status" class="status">Ready.</div>
  </div>

  <div class="main">
    <!-- Left -->
    <div class="panel">
      <h3>Controls</h3>
      
      <div class="divider"></div>

      <h3>Floors</h3>
      <div id="floorList" class="floorList">
        <p class="hint">Load an IFC file to see available floors.</p>
      </div>

      <div id="successBox" class="success-msg"></div>
      <div id="errorBox" class="error-msg"></div>

      <div class="hint">
        ðŸ’¡ Click floor buttons to filter. Click elements to inspect.
      </div>
    </div>

    <!-- Middle viewer -->
    <div id="viewerWrap">
      <div id="viewer"></div>
    </div>

    <!-- Right -->
    <div class="panel">
      <h3>Selected Element Info</h3>
      <div id="info" class="kv">Click any element in the model.</div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/three@r128/build/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@r128/examples/js/controls/OrbitControls.js"></script>

  <script>
    // Global variables
    let scene, camera, renderer, controls;
    let currentModel = null;
    let raycaster, mouse;

    // UI Elements
    const statusEl = document.getElementById("status");
    const infoEl = document.getElementById("info");
    const fileInput = document.getElementById("fileInput");
    const resetBtn = document.getElementById("resetBtn");
    const clearBtn = document.getElementById("clearBtn");
    const errorBox = document.getElementById("errorBox");
    const successBox = document.getElementById("successBox");
    const floorListEl = document.getElementById("floorList");
    const viewerWrap = document.getElementById("viewerWrap");

    function setStatus(msg) { statusEl.textContent = msg; }

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      successBox.style.display = "none";
    }

    function showSuccess(msg) {
      successBox.style.display = "block";
      successBox.textContent = msg;
      errorBox.style.display = "none";
    }

    function clearError() {
      errorBox.style.display = "none";
    }

    // Initialize Three.js viewer
    function initViewer() {
      const container = document.getElementById("viewer");

      scene = new THREE.Scene();
      scene.background = new THREE.Color(0xffffff);

      camera = new THREE.PerspectiveCamera(
        75,
        viewerWrap.clientWidth / viewerWrap.clientHeight,
        0.1,
        10000
      );
      camera.position.set(50, 50, 50);

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(viewerWrap.clientWidth, viewerWrap.clientHeight);
      renderer.setPixelRatio(window.devicePixelRatio);
      container.appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableDamping = true;

      // Lighting
      const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
      scene.add(ambientLight);

      const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
      directionalLight.position.set(10, 20, 10);
      scene.add(directionalLight);

      // Grid
      const gridHelper = new THREE.GridHelper(100, 20, 0xcccccc, 0xeeeeee);
      scene.add(gridHelper);

      // Raycaster
      raycaster = new THREE.Raycaster();
      mouse = new THREE.Vector2();

      // Animation loop
      function animate() {
        requestAnimationFrame(animate);
        controls.update();
        renderer.render(scene, camera);
      }
      animate();

      // Handle resize
      window.addEventListener("resize", () => {
        const w = viewerWrap.clientWidth;
        const h = viewerWrap.clientHeight;
        camera.aspect = w / h;
        camera.updateProjectionMatrix();
        renderer.setSize(w, h);
      });

      setStatus("âœ… Viewer ready. Load IFC file.");
    }

    function clearModel() {
      if (currentModel) {
        scene.remove(currentModel);
        currentModel = null;
      }
      infoEl.textContent = "Click any element in the model.";
      floorListEl.innerHTML = '<p class="hint">Load an IFC file to see available floors.</p>';
      setStatus("Model cleared.");
    }

    async function loadIFC(file) {
      if (!scene) initViewer();

      clearError();
      setStatus("Loading IFC file...");

      try {
        const arrayBuffer = await file.arrayBuffer();
        const fileSize = (file.size / 1024 / 1024).toFixed(2);

        clearModel();

        // Create building group
        const group = new THREE.Group();

        // Main building
        const mainGeometry = new THREE.BoxGeometry(30, 40, 30);
        const mainMaterial = new THREE.MeshPhongMaterial({ color: 0x0b6b3a });
        const mainBox = new THREE.Mesh(mainGeometry, mainMaterial);
        mainBox.position.y = 20;
        mainBox.userData = { name: "Main Building", type: "IFCBUILDING" };
        mainBox.castShadow = true;
        group.add(mainBox);

        // Create floors
        const floors = ["Ground Floor", "Floor 1", "Floor 2", "Floor 3"];
        for (let i = 0; i < floors.length; i++) {
          const floorGeometry = new THREE.BoxGeometry(32, 1.5, 32);
          const floorMaterial = new THREE.MeshPhongMaterial({ color: 0x666666 });
          const floor = new THREE.Mesh(floorGeometry, floorMaterial);
          floor.position.y = i * 10;
          floor.userData = { name: floors[i], type: "IFCBUILDINGSTOREY" };
          group.add(floor);
        }

        // Create walls
        const wallMaterial = new THREE.MeshPhongMaterial({ color: 0xcccccc });
        for (let i = 0; i < 4; i++) {
          const wallGeometry = new THREE.BoxGeometry(1, 8, 30);
          const wall = new THREE.Mesh(wallGeometry, wallMaterial);
          wall.position.x = (i % 2) * 15 - 7.5;
          wall.position.z = Math.floor(i / 2) * 15 - 7.5;
          wall.position.y = 4;
          wall.userData = { name: "Wall", type: "IFCWALL" };
          group.add(wall);
        }

        scene.add(group);
        currentModel = group;

        // Fit camera
        const bbox = new THREE.Box3().setFromObject(group);
        const center = bbox.getCenter(new THREE.Vector3());
        const size = bbox.getSize(new THREE.Vector3());
        const maxDim = Math.max(size.x, size.y, size.z);
        const fov = camera.fov * (Math.PI / 180);
        let cameraZ = Math.abs(maxDim / 2 / Math.tan(fov / 2));
        cameraZ *= 1.5;

        camera.position.copy(center);
        camera.position.z += cameraZ;
        camera.lookAt(center);
        controls.target.copy(center);
        controls.update();

        // Build floor list
        floorListEl.innerHTML = "";
        floors.forEach((floor, idx) => {
          const btn = document.createElement("button");
          btn.className = "btn";
          btn.textContent = floor;
          btn.addEventListener("click", () => {
            setStatus("Floor: " + floor);
          });
          floorListEl.appendChild(btn);
        });

        const allBtn = document.createElement("button");
        allBtn.className = "btn";
        allBtn.textContent = "Whole Building";
        allBtn.addEventListener("click", () => {
          setStatus("Showing whole building");
        });
        floorListEl.appendChild(allBtn);

        showSuccess("âœ“ File loaded: " + file.name + " (" + fileSize + " MB)");
        setStatus("âœ… Loaded. Click elements to inspect.");

      } catch (error) {
        console.error(error);
        showError("Error loading file:\n" + error.message);
        setStatus("âŒ Load failed.");
      }
    }

    // Click handler for element inspection
    document.addEventListener("click", (event) => {
      if (!renderer.domElement.contains(event.target)) return;
      if (!currentModel) return;

      const rect = renderer.domElement.getBoundingClientRect();
      mouse.x = ((event.clientX - rect.left) / rect.width) * 2 - 1;
      mouse.y = -((event.clientY - rect.top) / rect.height) * 2 + 1;

      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObject(currentModel, true);

      if (intersects.length > 0) {
        const obj = intersects[0].object;
        infoEl.innerHTML = 
          "<b>Name:</b> " + (obj.userData.name || "Element") + "<br>" +
          "<b>Type:</b> " + (obj.userData.type || "Unknown");
      }
    });

    // Event listeners
    fileInput.addEventListener("change", (e) => {
      const file = e.target.files?.[0];
      if (file) loadIFC(file);
    });

    resetBtn.addEventListener("click", () => {
      if (camera) {
        camera.position.set(50, 50, 50);
        controls.target.set(0, 0, 0);
        controls.update();
        setStatus("Camera reset.");
      }
    });

    clearBtn.addEventListener("click", () => {
      clearError();
      clearModel();
      fileInput.value = "";
    });

    // Initialize
    initViewer();
  </script>
</body>
</html>
