<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>KAU IFC Viewer</title>

  <style>
    :root{
      --kau-green:#0b6b3a;
      --bg:#ffffff;
      --panel:#f2f3f5;
      --panel2:#e6e7ea;
      --text:#111;
      --muted:#666;
      --border:#d7d9de;
      --btn:#e9eaee;
      --btn-hover:#dfe1e7;
      --danger:#b91c1c;
    }

    *{ box-sizing:border-box; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body{ margin:0; background:var(--bg); color:var(--text); }

    .topbar{
      background:var(--kau-green);
      color:#fff;
      padding:10px 14px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:600;
      letter-spacing:.2px;
    }

    .toolbar{
      display:flex;
      gap:10px;
      align-items:center;
      padding:10px 12px;
      background:var(--panel);
      border-bottom:1px solid var(--border);
    }

    .toolbar .label{
      font-size:14px;
      color:var(--text);
      font-weight:600;
      white-space: nowrap;
    }

    /* Smaller input slot */
    input[type="file"]{
      width:240px;
      max-width:240px;
      padding:6px;
      background:#fff;
      border:1px solid var(--border);
      border-radius:8px;
    }

    .btn{
      padding:8px 10px;
      border:1px solid var(--border);
      background:var(--btn);
      border-radius:10px;
      cursor:pointer;
      font-weight:600;
      white-space: nowrap;
    }
    .btn:hover{ background:var(--btn-hover); }

    .status{
      margin-left:auto;
      font-size:13px;
      color:var(--muted);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:45vw;
    }

    .main{
      height: calc(100vh - 48px - 52px);
      display:grid;
      grid-template-columns: 280px 1fr 320px;
      gap:10px;
      padding:10px;
    }

    .panel{
      background:var(--panel);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px;
      overflow:auto;
    }

    .panel h3{
      margin:0 0 8px 0;
      font-size:14px;
    }

    #viewerWrap{
      background:#fff;
      border:1px solid var(--border);
      border-radius:14px;
      overflow:hidden;
      position:relative;
    }
    #viewer{
      position:absolute;
      inset:0;
    }

    .smallRow{
      display:flex;
      gap:8px;
      align-items:center;
      flex-wrap:wrap;
      margin-bottom:10px;
    }

    .toggle{
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px;
      background:var(--panel2);
      border:1px solid var(--border);
      border-radius:12px;
      font-size:13px;
      width: 100%;
    }

    .floorList .btn{
      width:100%;
      text-align:left;
      margin:6px 0;
    }

    .hint{
      font-size:12px;
      color:var(--muted);
      line-height:1.35;
      margin-top:8px;
    }

    .kv{
      font-size:13px;
      line-height:1.5;
    }
    .kv b{ display:inline-block; min-width:120px; }
    .divider{
      height:1px;
      background:var(--border);
      margin:10px 0;
    }

    #errorBox{
      margin-top:10px;
      padding:10px;
      border:1px solid var(--border);
      border-radius:12px;
      background:#fff;
      color:var(--danger);
      font-size:12px;
      white-space:pre-wrap;
      word-break:break-word;
      display:none;
    }
  </style>
</head>

<body>
  <div class="topbar">Architecture and Design College — King Abdulaziz University</div>

  <div class="toolbar">
    <div class="label">Load IFC</div>
    <input id="fileInput" type="file" accept=".ifc" />
    <button id="resetBtn" class="btn" type="button">Reset Camera</button>
    <button id="clearBtn" class="btn" type="button">Clear Model</button>
    <div id="status" class="status">Ready.</div>
  </div>

  <div class="main">
    <!-- Left -->
    <div class="panel">
      <h3>Controls</h3>

      <div class="smallRow">
        <div class="toggle">
          <input id="roomsOnly" type="checkbox" />
          <label for="roomsOnly">Rooms only (we’ll connect this next)</label>
        </div>
      </div>

      <div class="divider"></div>

      <h3>Floors</h3>
      <div class="floorList">
        <button class="btn" type="button" data-floor="lower">Lower Floor</button>
        <button class="btn" type="button" data-floor="1">Floor 1</button>
        <button class="btn" type="button" data-floor="2">Floor 2</button>
        <button class="btn" type="button" data-floor="3">Floor 3</button>
        <button class="btn" type="button" data-floor="4">Floor 4</button>
        <button class="btn" type="button" data-floor="all">Whole Building</button>
      </div>

      <div id="errorBox"></div>

      <div class="hint">
        If your IFC is large, first load can take time. If it fails, the red box will show why.
      </div>
    </div>

    <!-- Middle viewer -->
    <div id="viewerWrap">
      <div id="viewer"></div>
    </div>

    <!-- Right -->
    <div class="panel">
      <h3>Selected Element Info</h3>
      <div id="info" class="kv">Click any element in the model.</div>
      <div class="divider"></div>
      <div class="hint">
        Next: full properties + random room colors + real floor filtering + category toggles.
      </div>
    </div>
  </div>

  <script type="module">
    // ✅ ESM CDN imports (bundled + browser-safe, no importmap needed)
    import * as THREE from "https://esm.sh/three@0.155.0";
    import { IfcViewerAPI } from "https://esm.sh/web-ifc-viewer@1.0.218";

    const statusEl = document.getElementById("status");
    const infoEl = document.getElementById("info");
    const fileInput = document.getElementById("fileInput");
    const resetBtn = document.getElementById("resetBtn");
    const clearBtn = document.getElementById("clearBtn");
    const errorBox = document.getElementById("errorBox");
    const viewerWrap = document.getElementById("viewerWrap");

    let viewer = null;
    let currentModelID = null;

    function setStatus(msg){ statusEl.textContent = msg; }

    function showError(msg){
      errorBox.style.display = "block";
      errorBox.textContent = msg;
    }

    function clearError(){
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    function escapeHtml(v){
      return String(v).replace(/[&<>"']/g, (m) => ({
        "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
      }[m]));
    }

    function clearInfo(){
      infoEl.innerHTML = "Click any element in the model.";
    }

    function initViewer(){
      const container = document.getElementById("viewer");

      viewer = new IfcViewerAPI({
        container,
        backgroundColor: new THREE.Color(0xffffff)
      });

      // WASM path for IFC parsing
      // Using unpkg folder (contains the WASM file)
      viewer.IFC.setWasmPath("https://unpkg.com/web-ifc@0.0.66/");

      viewer.axes.setAxes();
      viewer.grid.setGrid();

      setStatus("Viewer initialized. Choose an IFC file.");
    }

    function clearModel(){
      if (!viewer) return;

      if (currentModelID !== null){
        try { viewer.IFC.loader.ifcManager.close(currentModelID); } catch (e) {}
        currentModelID = null;
      }
      clearInfo();
      setStatus("Model cleared.");
      // Note: we do NOT clear the file input; the file remains selected.
    }

    async function loadIfcFromFile(file){
      if (!viewer) initViewer();

      setStatus("Loading IFC… (large files may take time)");
      clearInfo();

      clearModel(); // clears previous model if any

      const model = await viewer.IFC.loadIfc(file, true);
      currentModelID = model.modelID;

      try { viewer.context.fitToFrame(); } catch (e) {}
      setStatus("Model loaded ✅ Click any element to see info.");
    }

    async function pickAndShowInfo(){
      if (!viewer || currentModelID === null) return;

      const result = await viewer.IFC.selector.pickIfcItem(false);
      if (!result) return;

      const props = await viewer.IFC.getProperties(result.modelID, result.id, true, true);

      const name = props?.Name?.value ?? "-";
      const globalId = props?.GlobalId?.value ?? "-";
      const type = props?.type ?? "-";

      infoEl.innerHTML = `
        <div><b>Name:</b> ${escapeHtml(name)}</div>
        <div><b>Type:</b> ${escapeHtml(type)}</div>
        <div><b>GlobalId:</b> ${escapeHtml(globalId)}</div>
      `;
    }

    // Init immediately (so you never see "viewer not initialized")
    try{
      initViewer();
    }catch(err){
      console.error(err);
      showError("Viewer init failed:\n" + (err?.stack || err?.message || String(err)));
      setStatus("Init failed ❌");
    }

    // File select
    fileInput.addEventListener("change", async (e) => {
      clearError();
      const file = e.target.files?.[0];
      if (!file) return;

      try{
        await loadIfcFromFile(file);
      }catch(err){
        console.error(err);
        showError("IFC load failed:\n" + (err?.stack || err?.message || String(err)));
        setStatus("Failed to load IFC ❌");
      }
    });

    // Reset camera
    resetBtn.addEventListener("click", () => {
      if (!viewer) return;
      try { viewer.context.fitToFrame(); } catch (e) {}
      setStatus("Camera reset.");
    });

    // Clear model
    clearBtn.addEventListener("click", () => {
      clearError();
      clearModel();
    });

    // Click to pick
    viewerWrap.addEventListener("click", async () => {
      try { await pickAndShowInfo(); } catch (e) {}
    });

    // Placeholders for next steps
    document.getElementById("roomsOnly").addEventListener("change", (e) => {
      setStatus(e.target.checked ? "Rooms only: ON (filtering next)" : "Rooms only: OFF");
    });

    document.querySelectorAll("[data-floor]").forEach(btn => {
      btn.addEventListener("click", () => {
        setStatus(`Floor filter: ${btn.dataset.floor} (storey filtering next)`);
      });
    });
  </script>
</body>
</html>
