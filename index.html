<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>KAU IFC Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Libraries -->
  <script src="https://unpkg.com/three@0.152.2/build/three.min.js"></script>
  <script src="https://unpkg.com/web-ifc@0.0.57/web-ifc-api.js"></script>
  <script src="https://unpkg.com/ifc-viewer@1.0.250/dist/ifc-viewer.js"></script>

  <style>
    :root{
      --kau-green:#006C35;
      --bg:#ffffff;
      --panel:#f3f4f6;
      --border:#d1d5db;
      --text:#111827;
      --muted:#4b5563;
      --btn:#e5e7eb;
      --btnHover:#d1d5db;
      --danger:#b91c1c;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    header {
      height: 64px;
      background: var(--kau-green);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 18px;
      letter-spacing: 0.2px;
    }

    /* Controls bar */
    .top-controls{
      position: absolute;
      top: 74px;
      left: 12px;
      right: 12px;
      height: 54px;
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      display:flex;
      align-items:center;
      gap:10px;
      padding: 10px;
      z-index: 20;
    }

    .label{
      font-weight: 700;
      color: var(--muted);
      white-space: nowrap;
    }

    /* SMALLER input */
    .file{
      width: 260px;        /* <-- make it smaller */
      max-width: 44vw;     /* responsive */
      background: white;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 8px;
    }

    .btn{
      background: var(--btn);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 700;
      color: var(--text);
      white-space: nowrap;
    }
    .btn:hover{ background: var(--btnHover); }

    #viewer {
      width: 100%;
      height: calc(100% - 64px);
      background: white;
    }

    /* Status */
    #statusWrap{
      position:absolute;
      bottom: 10px;
      left: 12px;
      right: 12px;
      z-index: 20;
      display:flex;
      gap:10px;
      align-items: stretch;
    }

    #statusText{
      flex: 1;
      background: rgba(243,244,246,0.92);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      color: var(--muted);
      font-size: 13px;
    }

    #errorBox{
      width: 420px;
      max-width: 40vw;
      background: rgba(255,255,255,0.95);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      overflow:auto;
      color: var(--danger);
      display:none;
      white-space: pre-wrap;
      word-break: break-word;
    }

    /* Loading overlay */
    .overlay{
      position:absolute;
      inset: 64px 0 0 0;
      display:none;
      align-items:center;
      justify-content:center;
      z-index: 30;
      background: rgba(255,255,255,0.72);
      backdrop-filter: blur(2px);
    }
    .overlay .card{
      width: min(520px, 92vw);
      background: white;
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 16px;
      box-shadow: 0 12px 30px rgba(0,0,0,0.12);
    }
    .overlay .title{
      font-weight: 900;
      font-size: 16px;
      margin-bottom: 8px;
    }
    .overlay .msg{
      color: var(--muted);
      font-size: 13px;
      line-height: 1.35;
      margin-bottom: 12px;
    }
    .overlay .bar{
      height: 10px;
      background: #eee;
      border-radius: 999px;
      overflow:hidden;
      border: 1px solid var(--border);
    }
    .overlay .bar > div{
      height: 100%;
      width: 35%;
      background: var(--kau-green);
      border-radius: 999px;
      animation: indeterminate 1.1s infinite ease-in-out;
    }
    @keyframes indeterminate{
      0%{ transform: translateX(-60%); width: 30%; }
      50%{ transform: translateX(40%); width: 45%; }
      100%{ transform: translateX(160%); width: 30%; }
    }
  </style>
</head>

<body>
  <header>Architecture and Design College — King Abdulaziz University</header>

  <div class="top-controls">
    <span class="label">Load IFC:</span>
    <input type="file" id="fileInput" class="file" accept=".ifc" />
    <button id="btnLoad" class="btn">Load</button>
    <button id="btnClear" class="btn">Clear Model</button>
  </div>

  <div id="viewer"></div>

  <div id="statusWrap">
    <div id="statusText">Ready. Choose an IFC file, then press Load.</div>
    <div id="errorBox"></div>
  </div>

  <div id="overlay" class="overlay">
    <div class="card">
      <div class="title">Loading IFC…</div>
      <div id="overlayMsg" class="msg">
        Parsing IFC and generating geometry (this can take time for big models).
      </div>
      <div class="bar"><div></div></div>
    </div>
  </div>

  <script>
    const container = document.getElementById("viewer");
    const statusText = document.getElementById("statusText");
    const errorBox = document.getElementById("errorBox");
    const overlay = document.getElementById("overlay");
    const overlayMsg = document.getElementById("overlayMsg");
    const fileInput = document.getElementById("fileInput");
    const btnLoad = document.getElementById("btnLoad");
    const btnClear = document.getElementById("btnClear");

    let viewer = null;
    let loadedModel = null;

    function setStatus(msg) {
      statusText.textContent = msg;
    }

    function showError(msg) {
      errorBox.style.display = "block";
      errorBox.textContent = msg;
      setStatus("Error ❌ See the red box on the right.");
    }

    function clearError() {
      errorBox.style.display = "none";
      errorBox.textContent = "";
    }

    function setOverlay(on, msg) {
      overlay.style.display = on ? "flex" : "none";
      if (msg) overlayMsg.textContent = msg;
    }

    // 1) Create viewer safely (and show errors if something fails)
    try {
      if (typeof IfcViewerAPI === "undefined") {
        showError("IfcViewerAPI is undefined. The viewer library did not load from unpkg.");
      } else {
        viewer = new IfcViewerAPI({ container, backgroundColor: 0xffffff });
        viewer.IFC.setWasmPath("https://unpkg.com/web-ifc@0.0.57/");
        setStatus("Viewer ready. Choose an IFC file, then press Load.");
      }
    } catch (e) {
      showError("Failed to create viewer: " + (e && e.message ? e.message : String(e)));
    }

    // 2) Clear model (does NOT clear file input)
    function clearModel() {
      if (!viewer) return;
      try {
        if (loadedModel) {
          viewer.context.scene.remove(loadedModel);
          loadedModel = null;
        }
        // Try to clear IFC internal state if possible
        try { viewer.IFC.loader.ifcManager.dispose(); } catch (e) {}
        setStatus("Model cleared. Choose an IFC file, then press Load.");
      } catch (e) {
        showError("Clear model failed: " + (e && e.message ? e.message : String(e)));
      }
    }

    btnClear.addEventListener("click", () => {
      clearError();
      clearModel();
    });

    // 3) Load button (more reliable than relying on change event)
    btnLoad.addEventListener("click", async () => {
      clearError();
      if (!viewer) {
        showError("Viewer is not initialized.");
        return;
      }

      const file = fileInput.files && fileInput.files[0];
      if (!file) {
        setStatus("Please choose an IFC file first.");
        return;
      }

      // Arabic name is usually fine, but renaming removes edge cases
      setStatus("Selected: " + file.name + " — starting load…");
      setOverlay(true, "Reading file…");

      await new Promise(r => setTimeout(r, 50));
      const url = URL.createObjectURL(file);

      try {
        // Remove any existing model first (so reload works)
        clearModel();

        setOverlay(true, "Parsing IFC and generating 3D geometry (slow part)…");
        loadedModel = await viewer.IFC.loadIfcUrl(url);

        setOverlay(true, "Finishing…");
        viewer.context.fitToFrame();

        setOverlay(false);
        setStatus("Loaded ✅ You can orbit/zoom. Next: click elements to show info panel.");
      } catch (e) {
        setOverlay(false);
        showError(
          "IFC load failed.\n\n" +
          "Try these:\n" +
          "1) Rename the file to English (e.g., KAU.ifc)\n" +
          "2) Try a smaller IFC to test\n" +
          "3) Open DevTools Console and share the error text\n\n" +
          "Error details:\n" + (e && e.stack ? e.stack : (e && e.message ? e.message : String(e)))
        );
      }
    });

    // Optional: show that file selection changed
    fileInput.addEventListener("change", () => {
      const file = fileInput.files && fileInput.files[0];
      if (file) {
        setStatus("Selected: " + file.name + " — press Load.");
      } else {
        setStatus("Ready. Choose an IFC file, then press Load.");
      }
    });

    window.addEventListener("resize", () => {
      try { if (viewer) viewer.context.resize(); } catch (e) {}
    });
  </script>
</body>
</html>
