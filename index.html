<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>KAU IFC Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
:root{
  --kau-green:#0b6b3a;
  --panel:#f2f3f5;
  --border:#d7d9de;
  --btn:#e9eaee;
}
body{margin:0;font-family:system-ui;background:#fff;}
.topbar{
  background:var(--kau-green);
  color:#fff;
  padding:10px;
  text-align:center;
  font-weight:600;
}
.toolbar{
  display:flex;
  gap:10px;
  padding:10px;
  background:var(--panel);
  border-bottom:1px solid var(--border);
}
input[type=file]{width:220px;}
button{
  background:var(--btn);
  border:1px solid var(--border);
  border-radius:6px;
  padding:6px 10px;
  cursor:pointer;
}
.main{
  display:grid;
  grid-template-columns:260px 1fr 300px;
  height:calc(100vh - 96px);
  gap:10px;
  padding:10px;
}
.panel{
  background:var(--panel);
  border:1px solid var(--border);
  border-radius:12px;
  padding:10px;
}
#viewerWrap{
  position:relative;
  border:1px solid var(--border);
  border-radius:12px;
  overflow:hidden;
}
canvas{
  width:100%;
  height:100%;
  display:block;
}
</style>
</head>

<body>

<div class="topbar">
Architecture and Design College — King Abdulaziz University
</div>

<div class="toolbar">
  <input id="fileInput" type="file" accept=".ifc">
  <button id="resetBtn">Reset View</button>
  <span id="status">Ready</span>
</div>

<div class="main">
  <div class="panel">Floors (next)</div>

  <div id="viewerWrap">
    <canvas id="c"></canvas>
  </div>

  <div class="panel">
    <b>Element Info</b>
    <div id="info">Click element</div>
  </div>
</div>

<script type="module">
import * as THREE from "https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.module.js";
import { OrbitControls } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/controls/OrbitControls.js";
import { IFCLoader } from "https://cdn.jsdelivr.net/npm/three@0.152.2/examples/jsm/loaders/IFCLoader.js";

const WASM_PATH = "https://cdn.jsdelivr.net/npm/web-ifc@0.0.57/";

const canvas = document.getElementById("c");
const status = document.getElementById("status");
const info = document.getElementById("info");

const scene = new THREE.Scene();
scene.background = new THREE.Color(0xffffff);

const camera = new THREE.PerspectiveCamera(60,1,0.1,2000);
camera.position.set(15,12,15);

const renderer = new THREE.WebGLRenderer({canvas: canvas, antialias:true});
renderer.setPixelRatio(window.devicePixelRatio);

const controls = new OrbitControls(camera,renderer.domElement);
controls.enableDamping = true;

scene.add(new THREE.AmbientLight(0xffffff,0.8));
const dir = new THREE.DirectionalLight(0xffffff,0.6);
dir.position.set(10,20,10);
scene.add(dir);

scene.add(new THREE.GridHelper(100,100));
scene.add(new THREE.AxesHelper(5));

const ifcLoader = new IFCLoader();
ifcLoader.ifcManager.setWasmPath(WASM_PATH);

let ifcModel = null;

function resize(){
  const w = canvas.parentElement.clientWidth;
  const h = canvas.parentElement.clientHeight;
  renderer.setSize(w,h,false);
  camera.aspect = w/h;
  camera.updateProjectionMatrix();
}
new ResizeObserver(resize).observe(canvas.parentElement);
resize();

function animate(){
  controls.update();
  renderer.render(scene,camera);
  requestAnimationFrame(animate);
}
animate();

document.getElementById("fileInput").addEventListener("change", async function(e){
  const file = e.target.files[0];
  if(!file) return;

  status.textContent = "Loading IFC...";

  if(ifcModel){
    scene.remove(ifcModel);
    ifcModel = null;
  }

  const url = URL.createObjectURL(file);
  const model = await ifcLoader.loadAsync(url);
  ifcModel = model;
  scene.add(ifcModel);

  controls.reset();
  status.textContent = "Loaded ✔";
});

canvas.addEventListener("click", async function(e){
  if(!ifcModel) return;

  const rect = canvas.getBoundingClientRect();
  const mouse = new THREE.Vector2(
    ((e.clientX - rect.left) / rect.width) * 2 - 1,
    -((e.clientY - rect.top) / rect.height) * 2 + 1
  );

  const ray = new THREE.Raycaster();
  ray.setFromCamera(mouse,camera);

  const hit = ray.intersectObject(ifcModel)[0];
  if(!hit) return;

  const id = ifcLoader.ifcManager.getExpressId(
    hit.object.geometry,
    hit.faceIndex
  );

  const props = await ifcLoader.ifcManager.getItemProperties(
    ifcModel.modelID,
    id,
    true
  );

  info.innerHTML =
    "<div><b>Name:</b> " + (props.Name?.value || "-") + "</div>" +
    "<div><b>Type:</b> " + (props.type || "-") + "</div>" +
    "<div><b>GlobalId:</b> " + (props.GlobalId?.value || "-") + "</div>";
});

document.getElementById("resetBtn").addEventListener("click", function(){
  controls.reset();
});
</script>

</body>
</html>
