<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>KAU IFC Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body {
  margin: 0;
  font-family: system-ui, Arial;
  background: #ffffff;
}

header {
  background: #0b6b3a;
  color: white;
  padding: 10px;
  text-align: center;
  font-weight: 600;
}

.toolbar {
  display: flex;
  gap: 10px;
  padding: 10px;
  background: #f2f2f2;
  border-bottom: 1px solid #ccc;
}

input[type="file"] {
  width: 220px;
}

button {
  padding: 6px 10px;
  background: #e5e5e5;
  border: 1px solid #bbb;
  border-radius: 6px;
  cursor: pointer;
}

main {
  display: grid;
  grid-template-columns: 260px 1fr 300px;
  height: calc(100vh - 92px);
}

.panel {
  padding: 10px;
  border-right: 1px solid #ddd;
  background: #f8f8f8;
  overflow: auto;
}

#viewer {
  width: 100%;
  height: 100%;
}

#info {
  font-size: 14px;
}
</style>
</head>

<body>

<header>
Architecture and Design College — King Abdulaziz University
</header>

<div class="toolbar">
  <input id="fileInput" type="file" accept=".ifc">
  <button id="resetBtn">Reset View</button>
  <span id="status">Ready</span>
</div>

<main>
  <div class="panel">
    <b>Floors</b><br><br>
    Floor controls coming next
  </div>

  <div id="viewer"></div>

  <div class="panel">
    <b>Element Info</b>
    <div id="info">Click an element</div>
  </div>
</main>

<script type="module">
import * as THREE from "https://unpkg.com/three@0.155.0/build/three.module.js";
import { OrbitControls } from "https://unpkg.com/three@0.155.0/examples/jsm/controls/OrbitControls.js";
import { IFCLoader } from "https://unpkg.com/three@0.155.0/examples/jsm/loaders/IFCLoader.js";

let scene, camera, renderer, controls;
let ifcLoader, ifcModel;

init();

function init() {
  scene = new THREE.Scene();
  scene.background = new THREE.Color(0xffffff);

  camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
  camera.position.set(10, 10, 10);

  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(window.innerWidth, window.innerHeight);
  document.getElementById("viewer").appendChild(renderer.domElement);

  controls = new OrbitControls(camera, renderer.domElement);
  controls.enableDamping = true;

  scene.add(new THREE.AmbientLight(0xffffff, 0.9));
  const dirLight = new THREE.DirectionalLight(0xffffff, 0.6);
  dirLight.position.set(5, 10, 5);
  scene.add(dirLight);

  ifcLoader = new IFCLoader();
  ifcLoader.ifcManager.setWasmPath(
    "https://unpkg.com/web-ifc@0.0.57/"
  );

  window.addEventListener("resize", onResize);
  renderer.domElement.addEventListener("click", pick);

  animate();
}

function animate() {
  controls.update();
  renderer.render(scene, camera);
  requestAnimationFrame(animate);
}

function onResize() {
  camera.aspect = window.innerWidth / window.innerHeight;
  camera.updateProjectionMatrix();
  renderer.setSize(window.innerWidth, window.innerHeight);
}

document.getElementById("fileInput").addEventListener("change", async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  document.getElementById("status").textContent = "Loading IFC…";

  if (ifcModel) scene.remove(ifcModel);

  const url = URL.createObjectURL(file);
  ifcModel = await ifcLoader.loadAsync(url);
  scene.add(ifcModel);

  document.getElementById("status").textContent = "Loaded ✔";
});

document.getElementById("resetBtn").onclick = () => {
  controls.reset();
};

async function pick(event) {
  if (!ifcModel) return;

  const mouse = new THREE.Vector2(
    (event.clientX / window.innerWidth) * 2 - 1,
    -(event.clientY / window.innerHeight) * 2 + 1
  );

  const raycaster = new THREE.Raycaster();
  raycaster.setFromCamera(mouse, camera);

  const intersects = raycaster.intersectObject(ifcModel);
  if (intersects.length === 0) return;

  const faceIndex = intersects[0].faceIndex;
  const geometry = intersects[0].object.geometry;
  const id = ifcLoader.ifcManager.getExpressId(geometry, faceIndex);

  const props = await ifcLoader.ifcManager.getItemProperties(ifcModel.modelID, id);

  document.getElementById("info").innerHTML = `
    <b>Type:</b> ${props?.type || "-"}<br>
    <b>GlobalId:</b> ${props?.GlobalId?.value || "-"}<br>
    <b>Name:</b> ${props?.Name?.value || "-"}
  `;
}
</script>

</body>
</html>
